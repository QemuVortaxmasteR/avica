name: Setup Windows Runner + noVNC + Tailscale

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  setup-gui-runner:
    runs-on: windows-latest
    env:
      USERNAME: runneradmin
      PASSWORD: MR.English2008

    steps:
      - uses: actions/checkout@v4

      - name: Set user password
        shell: powershell
        run: |
          net user $env:USERNAME $env:PASSWORD

      - name: Install TightVNC
        shell: powershell
        run: |
          choco install tightvnc -y

      - name: Install noVNC
        shell: powershell
        run: |
          git clone https://github.com/novnc/noVNC.git C:\noVNC
          pip install websockify

      - name: Open VNC ports
        shell: powershell
        run: |
          New-NetFirewallRule -DisplayName "Allow VNC 5900" -Direction Inbound -Protocol TCP -LocalPort 5900 -Action Allow
          New-NetFirewallRule -DisplayName "Allow noVNC 6080" -Direction Inbound -Protocol TCP -LocalPort 6080 -Action Allow

      - name: Install & Connect Tailscale
        shell: powershell
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.92.3-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=gh-runner-${{ github.run_id }}
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          "TAILSCALE_IP=$tsIP" | Out-File -Append $env:GITHUB_ENV

      - name: Start VNC and noVNC
        shell: powershell
        run: |
          Start-Process "C:\Program Files\TightVNC\tvnserver.exe"
          Start-Process powershell -ArgumentList "-NoProfile -Command websockify --web C:\noVNC 6080 localhost:5900"

          Write-Host "=== CONNECTION INFO ==="
          Write-Host "USERNAME: $env:USERNAME"
          Write-Host "PASSWORD: $env:PASSWORD"
          Write-Host "noVNC URL:"
          Write-Host "http://$env:TAILSCALE_IP:6080/vnc.html"

          while ($true) {
            Start-Sleep -Seconds 600
          }
