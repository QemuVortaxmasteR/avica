name: Setup Windows Runner + TightVNC + Tailscale (Manual Auth)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  setup-gui-runner:
    runs-on: windows-latest
    env:
      USERNAME: runneradmin
      PASSWORD: MR.English2008

    steps:
      - uses: actions/checkout@v4

      - name: Set VNC password user
        shell: powershell
        run: |
          net user $env:USERNAME $env:PASSWORD

      - name: Install TightVNC
        shell: powershell
        run: |
          choco install tightvnc -y

      - name: Configure TightVNC password
        shell: powershell
        run: |
          $pwd = "MR.English2008"
          $bytes = [System.Text.Encoding]::ASCII.GetBytes($pwd)
          $md5 = New-Object -TypeName System.Security.Cryptography.MD5CryptoServiceProvider
          $hash = $md5.ComputeHash($bytes)
          Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "Password" -Value $hash -Type Binary
          Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "AcceptRfbConnections" -Value 1
          Set-ItemProperty -Path "HKLM:\SOFTWARE\TightVNC\Server" -Name "LoopbackConnections" -Value 1

      - name: Open VNC firewall port
        shell: powershell
        run: |
          New-NetFirewallRule -DisplayName "Allow VNC 5900" -Direction Inbound -Protocol TCP -LocalPort 5900 -Action Allow

      - name: 1. Install & Connect Tailscale (Manual Auth)
        shell: powershell
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.92.3-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --hostname=gh-runner-${{ github.run_id }}
          $tsIP = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 | Select-Object -First 1).Trim()
          "TAILSCALE_IP=$tsIP" | Out-File -Append $env:GITHUB_ENV

      - name: Start TightVNC server
        shell: powershell
        run: |
          Start-Process "C:\Program Files\TightVNC\tvnserver.exe" -ArgumentList "-start"

      - name: Display connection info
        shell: powershell
        run: |
          Write-Host "=== CONNECTION INFO ==="
          Write-Host "VNC Username: (none, only password is required)"
          Write-Host "VNC Password: MR.English2008"
          Write-Host "Connect using VNC Viewer via Tailscale IP:"
          Write-Host "http://$env:TAILSCALE_IP:5900 or directly in any VNC client"
          while ($true) {
            Start-Sleep -Seconds 600
          }
