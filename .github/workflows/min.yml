name: Setup Windows Runner + noVNC + Tailscale

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  setup-gui-runner:
    runs-on: windows-latest
    env:
      USERNAME: runneradmin
      PASSWORD: MR.English2008
      TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      TAILSCALE_HOSTNAME: gh-win-novnc-${{ github.run_id }}

    steps:
      - uses: actions/checkout@v4

      - name: Set VNC password
        shell: powershell
        run: |
          net user $env:USERNAME $env:PASSWORD

      - name: Install TightVNC
        shell: powershell
        run: |
          choco install tightvnc -y

      - name: Install noVNC
        shell: powershell
        run: |
          git clone https://github.com/novnc/noVNC.git C:\noVNC
          pip install websockify

      - name: Open VNC and noVNC firewall ports
        shell: powershell
        run: |
          New-NetFirewallRule -DisplayName "Allow VNC 5900" -Direction Inbound -Protocol TCP -LocalPort 5900 -Action Allow
          New-NetFirewallRule -DisplayName "Allow noVNC 6080" -Direction Inbound -Protocol TCP -LocalPort 6080 -Action Allow

      - name: Install Tailscale
        shell: powershell
        run: |
          choco install tailscale -y
          & "C:\Program Files\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTHKEY --hostname=$env:TAILSCALE_HOSTNAME

      - name: Start VNC and noVNC
        shell: powershell
        run: |
          Start-Process "C:\Program Files\TightVNC\tvnserver.exe"
          Start-Process powershell -ArgumentList "-NoProfile -Command websockify --web C:\noVNC 6080 localhost:5900"

          $ip = & "C:\Program Files\Tailscale\tailscale.exe" ip -4 | Select-Object -First 1

          Write-Host "=== CONNECTION INFO ==="
          Write-Host "USERNAME: $env:USERNAME"
          Write-Host "PASSWORD: $env:PASSWORD"
          Write-Host "noVNC URL (via Tailscale):"
          Write-Host "http://$ip:6080/vnc.html"

          while ($true) {
            Start-Sleep -Seconds 600
          }
