name: Setup Windows Runner + TightVNC + Tailscale (Manual Auth)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  setup-gui-runner:
    runs-on: windows-latest
    env:
      USERNAME: runneradmin
      PASSWORD: MR.English2008

    steps:
      - uses: actions/checkout@v4

      - name: Set VNC password user
        shell: powershell
        run: |
          net user $env:USERNAME $env:PASSWORD

      - name: Install TightVNC
        shell: powershell
        run: |
          choco install tightvnc -y

      - name: Configure TightVNC via CLI
        shell: powershell
        run: |
          cd "C:\Program Files\TightVNC"
          tvnserver.exe -viewonlypassword Eng2008
          tvnserver.exe -controlpassword Eng2008
          sc start tvnserver

      - name: Open VNC firewall port
        shell: powershell
        run: |
          New-NetFirewallRule -DisplayName "Allow VNC 5900" -Direction Inbound -Protocol TCP -LocalPort 5900 -Action Allow

      - name: 1. Install & Connect Tailscale (Manual Auth)
        shell: powershell
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.92.3-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --hostname=gh-runner-${{ github.run_id }}
          $tsIP = (& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 | Select-Object -First 1).Trim()
          "TAILSCALE_IP=$tsIP" | Out-File -Append $env:GITHUB_ENV

      - name: Display connection info
        shell: powershell
        run: |
          Write-Host "=== CONNECTION INFO ==="
          Write-Host "VNC Username: (none)"
          Write-Host "VNC Password: Eng2008"
          Write-Host "VNC Address:"
          Write-Host "$env:TAILSCALE_IP:5900"
          while ($true) {
            Start-Sleep -Seconds 600
          }
